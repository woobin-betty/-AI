import React, { useState, useEffect } from 'react';
import { Calendar, Plus, Check, Clock, AlertCircle, ChevronRight, Trash2, Home, List, BarChart3, ChevronLeft, Target, TrendingUp, Award, X } from 'lucide-react';

const TaskDeadlineManager = () => {
  const [tasks, setTasks] = useState([]);
  const [currentView, setCurrentView] = useState('dashboard');
  const [showAddModal, setShowAddModal] = useState(false);
  const [showTaskDetail, setShowTaskDetail] = useState(false);
  const [newTask, setNewTask] = useState({ title: '', description: '', deadline: '' });
  const [isGenerating, setIsGenerating] = useState(false);
  const [selectedTask, setSelectedTask] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [currentDate, setCurrentDate] = useState(new Date());

  useEffect(() => {
    const loadTasks = async () => {
      try {
        const result = await window.storage.get('tasks');
        if (result?.value) setTasks(JSON.parse(result.value));
      } catch (error) {
        console.log('ì €ì¥ëœ ê³¼ì œ ì—†ìŒ');
      } finally {
        setIsLoading(false);
      }
    };
    loadTasks();
  }, []);

  useEffect(() => {
    if (!isLoading) {
      window.storage.set('tasks', JSON.stringify(tasks)).catch(console.error);
    }
  }, [tasks, isLoading]);

  const calculatePriority = (deadline) => {
    const daysLeft = Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
    if (daysLeft <= 2) return 'high';
    if (daysLeft <= 7) return 'medium';
    return 'low';
  };

  const generateDailyPlan = async (task) => {
    setIsGenerating(true);
    try {
      const daysLeft = Math.ceil((new Date(task.deadline) - new Date()) / (1000 * 60 * 60 * 24));
      const response = await fetch('https://api.anthropic.com/v1/messages', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-sonnet-4-20250514',
          max_tokens: 1500,
          messages: [{
            role: 'user',
            content: `ê³¼ì œ "${task.title}"ì„ ${daysLeft}ì¼ ë™ì•ˆ ìˆ˜í–‰í•  ì¼ì¼ ê³„íšì„ JSONìœ¼ë¡œë§Œ ì‘ì„±í•´ì£¼ì„¸ìš”.
{
  "difficulty": "ì‰¬ì›€/ë³´í†µ/ì–´ë ¤ì›€",
  "estimatedHours": ìˆ«ì,
  "dailyPlans": [
    {"day": 1, "date": "YYYY-MM-DD", "title": "ì˜¤ëŠ˜ í•  ì¼", "tasks": ["ì‘ì—…1", "ì‘ì—…2"], "duration": "ì‹œê°„", "focus": "í¬ì¸íŠ¸"}
  ],
  "steps": [{"title": "ë‹¨ê³„", "duration": "ì‹œê°„", "description": "ì„¤ëª…"}],
  "checklist": ["í•­ëª©1", "í•­ëª©2"]
}`
          }]
        })
      });

      const data = await response.json();
      const plan = JSON.parse(data.content[0].text.replace(/```json|```/g, '').trim());
      return plan;
    } catch (error) {
      const today = new Date();
      const daysLeft = Math.ceil((new Date(task.deadline) - today) / (1000 * 60 * 60 * 24));
      const dailyPlans = [];
      for (let i = 0; i < Math.min(daysLeft, 7); i++) {
        const d = new Date(today);
        d.setDate(d.getDate() + i);
        dailyPlans.push({
          day: i + 1,
          date: d.toISOString().split('T')[0],
          title: `${i + 1}ì¼ì°¨ ì‘ì—…`,
          tasks: ['ê³¼ì œ ì§„í–‰', 'ë‚´ìš© ê²€í† '],
          duration: '2ì‹œê°„',
          focus: 'ê¾¸ì¤€íˆ ì§„í–‰'
        });
      }
      return {
        difficulty: 'ë³´í†µ',
        estimatedHours: 4,
        dailyPlans,
        steps: [
          { title: 'ìš”êµ¬ì‚¬í•­ íŒŒì•…', duration: '30ë¶„', description: 'ê³¼ì œ ë‚´ìš© ì •ë¦¬' },
          { title: 'ìë£Œ ì¡°ì‚¬', duration: '1ì‹œê°„', description: 'ì°¸ê³ ìë£Œ ì°¾ê¸°' },
          { title: 'ê³¼ì œ ì‘ì„±', duration: '2ì‹œê°„', description: 'ë³¸ê²© ì‘ì—…' },
          { title: 'ê²€í†  ë° ì œì¶œ', duration: '30ë¶„', description: 'ìµœì¢… í™•ì¸' }
        ],
        checklist: ['íŒŒì¼ ì €ì¥ í™•ì¸', 'ì œì¶œ í˜•ì‹ í™•ì¸', 'ë§ˆê°ì‹œê°„ í™•ì¸']
      };
    } finally {
      setIsGenerating(false);
    }
  };

  const handleAddTask = async () => {
    if (!newTask.title.trim() || !newTask.deadline) {
      alert('ê³¼ì œëª…ê³¼ ë§ˆê°ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    const plan = await generateDailyPlan(newTask);
    setTasks(prev => [...prev, {
      id: Date.now(),
      ...newTask,
      priority: calculatePriority(newTask.deadline),
      plan,
      progress: 0,
      completedSteps: [],
      completedDays: [],
      createdAt: new Date().toISOString()
    }]);
    setShowAddModal(false);
    setNewTask({ title: '', description: '', deadline: '' });
  };

  const deleteTask = (taskId) => {
    if (confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      setTasks(prev => prev.filter(t => t.id !== taskId));
      if (selectedTask?.id === taskId) {
        setSelectedTask(null);
        setShowTaskDetail(false);
      }
    }
  };

  const toggleStep = (taskId, stepIndex) => {
    setTasks(prev => prev.map(task => {
      if (task.id === taskId) {
        const completedSteps = task.completedSteps.includes(stepIndex)
          ? task.completedSteps.filter(i => i !== stepIndex)
          : [...task.completedSteps, stepIndex];
        return { ...task, completedSteps, progress: Math.round((completedSteps.length / task.plan.steps.length) * 100) };
      }
      return task;
    }));
  };

  const toggleDailyPlan = (taskId, dayIndex) => {
    setTasks(prev => prev.map(task => {
      if (task.id === taskId) {
        const completedDays = task.completedDays.includes(dayIndex)
          ? task.completedDays.filter(i => i !== dayIndex)
          : [...task.completedDays, dayIndex];
        return { ...task, completedDays };
      }
      return task;
    }));
  };

  const getPriorityColor = (priority) => {
    const colors = {
      high: 'text-orange-600 bg-orange-50 border-orange-200',
      medium: 'text-blue-600 bg-blue-50 border-blue-200',
      low: 'text-gray-600 bg-gray-50 border-gray-200'
    };
    return colors[priority] || colors.low;
  };

  const getDaysLeft = (deadline) => {
    const daysLeft = Math.ceil((new Date(deadline) - new Date()) / (1000 * 60 * 60 * 24));
    if (daysLeft < 0) return 'ë§ˆê°ë¨';
    if (daysLeft === 0) return 'ì˜¤ëŠ˜';
    if (daysLeft === 1) return 'ë‚´ì¼';
    return `D-${daysLeft}`;
  };

  const getTodayTasks = () => {
    const today = new Date().toISOString().split('T')[0];
    return tasks.filter(task => 
      task.plan?.dailyPlans?.some(p => p.date === today)
    ).map(task => ({
      ...task,
      todayPlan: task.plan.dailyPlans.find(p => p.date === today),
      dayIndex: task.plan.dailyPlans.findIndex(p => p.date === today)
    }));
  };

  const getStats = () => {
    const total = tasks.length;
    const completed = tasks.filter(t => t.progress === 100).length;
    const inProgress = tasks.filter(t => t.progress > 0 && t.progress < 100).length;
    const avgProgress = total > 0 ? Math.round(tasks.reduce((sum, t) => sum + t.progress, 0) / total) : 0;
    return { total, completed, inProgress, avgProgress };
  };

  const renderCalendar = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    const firstDay = new Date(year, month, 1);
    const startDate = new Date(firstDay);
    startDate.setDate(startDate.getDate() - firstDay.getDay());
    const days = [];
    const current = new Date(startDate);

    for (let i = 0; i < 42; i++) {
      const dateStr = current.toISOString().split('T')[0];
      const dayTasks = tasks.filter(task => 
        task.plan?.dailyPlans?.some(p => p.date === dateStr)
      );
      days.push({
        date: new Date(current),
        dateStr,
        day: current.getDate(),
        isCurrentMonth: current.getMonth() === month,
        isToday: dateStr === new Date().toISOString().split('T')[0],
        tasks: dayTasks
      });
      current.setDate(current.getDate() + 1);
    }
    return days;
  };

  const todayTasks = getTodayTasks();
  const stats = getStats();
  const calendarDays = renderCalendar();
  const sortedTasks = [...tasks].sort((a, b) => {
    const order = { high: 3, medium: 2, low: 1 };
    if (order[a.priority] !== order[b.priority]) return order[b.priority] - order[a.priority];
    return new Date(a.deadline) - new Date(b.deadline);
  });

  const openTaskDetail = (task) => {
    setSelectedTask(task);
    setShowTaskDetail(true);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <div className="w-12 h-12 border-4 border-blue-600 border-t-transparent rounded-full animate-spin mx-auto mb-4" />
          <p className="text-gray-500">ë¡œë”© ì¤‘...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      <div className="max-w-md mx-auto bg-white min-h-screen shadow-2xl relative pb-20">
        <header className="bg-white border-b border-gray-200 sticky top-0 z-40">
          <div className="px-4 py-3">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-2">
                <div className="w-9 h-9 bg-gradient-to-br from-blue-600 to-blue-700 rounded-lg flex items-center justify-center">
                  <Target className="w-5 h-5 text-white" />
                </div>
                <div>
                  <h1 className="text-lg font-bold text-gray-900">ê³¼ì œ ê´€ë¦¬</h1>
                  <p className="text-xs text-gray-500">AI ì¼ì • ê´€ë¦¬</p>
                </div>
              </div>
              <button 
                onClick={() => setShowAddModal(true)} 
                className="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center shadow-lg active:scale-95 transition-transform"
              >
                <Plus className="w-5 h-5" />
              </button>
            </div>
          </div>
        </header>

        <main className="px-4 py-4">
          {currentView === 'dashboard' && (
            <div className="space-y-3">
              <div className="grid grid-cols-4 gap-2">
                <div className="bg-white rounded-lg p-3 border">
                  <List className="w-4 h-4 text-blue-600 mb-1" />
                  <p className="text-xl font-bold">{stats.total}</p>
                  <p className="text-[10px] text-gray-500">ì „ì²´</p>
                </div>
                <div className="bg-white rounded-lg p-3 border">
                  <Award className="w-4 h-4 text-green-600 mb-1" />
                  <p className="text-xl font-bold text-green-600">{stats.completed}</p>
                  <p className="text-[10px] text-gray-500">ì™„ë£Œ</p>
                </div>
                <div className="bg-white rounded-lg p-3 border">
                  <TrendingUp className="w-4 h-4 text-orange-600 mb-1" />
                  <p className="text-xl font-bold text-orange-600">{stats.inProgress}</p>
                  <p className="text-[10px] text-gray-500">ì§„í–‰ì¤‘</p>
                </div>
                <div className="bg-white rounded-lg p-3 border">
                  <BarChart3 className="w-4 h-4 text-blue-600 mb-1" />
                  <p className="text-xl font-bold text-blue-600">{stats.avgProgress}%</p>
                  <p className="text-[10px] text-gray-500">í‰ê· </p>
                </div>
              </div>

              <div className="bg-white rounded-lg p-3 border">
                <div className="flex items-center justify-between mb-2">
                  <h2 className="text-sm font-semibold flex items-center gap-1.5">
                    <Check className="w-4 h-4 text-blue-600" />ì˜¤ëŠ˜ í•  ì¼
                  </h2>
                  {todayTasks.length > 0 && (
                    <span className="text-xs text-gray-500">{todayTasks.length}ê°œ</span>
                  )}
                </div>
                {todayTasks.length === 0 ? (
                  <div className="text-center py-6">
                    <div className="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-2">
                      <Check className="w-6 h-6 text-gray-400" />
                    </div>
                    <p className="text-xs text-gray-500">ì˜¤ëŠ˜ ì˜ˆì •ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {todayTasks.map(task => (
                      <div key={task.id} className="p-2.5 bg-gray-50 rounded-lg active:bg-gray-100 cursor-pointer" onClick={() => openTaskDetail(task)}>
                        <div className="flex justify-between items-start mb-1.5">
                          <h3 className="font-medium text-sm flex-1 leading-tight">{task.title}</h3>
                          <span className={`text-[10px] px-1.5 py-0.5 rounded-full ml-2 flex-shrink-0 ${getPriorityColor(task.priority)}`}>
                            {getDaysLeft(task.deadline)}
                          </span>
                        </div>
                        <p className="text-xs text-gray-600 mb-1.5 line-clamp-1">{task.todayPlan.title}</p>
                        <div className="flex items-center gap-1.5 text-[11px] text-gray-500">
                          <Clock className="w-3 h-3" />{task.todayPlan.duration}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {sortedTasks.filter(t => t.progress > 0 && t.progress < 100).length > 0 && (
                <div className="bg-white rounded-lg p-3 border">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="text-sm font-semibold flex items-center gap-1.5">
                      <TrendingUp className="w-4 h-4 text-blue-600" />ì§„í–‰ ì¤‘
                    </h2>
                    <span className="text-xs text-gray-500">
                      {sortedTasks.filter(t => t.progress > 0 && t.progress < 100).length}ê°œ
                    </span>
                  </div>
                  <div className="space-y-2">
                    {sortedTasks.filter(t => t.progress > 0 && t.progress < 100).slice(0, 3).map(task => (
                      <div key={task.id} className="p-2.5 bg-blue-50 rounded-lg border border-blue-100 active:bg-blue-100 cursor-pointer" onClick={() => openTaskDetail(task)}>
                        <div className="flex justify-between items-center mb-1.5">
                          <h3 className="font-medium text-sm flex-1">{task.title}</h3>
                          <span className="text-xs font-bold text-blue-600">{task.progress}%</span>
                        </div>
                        <div className="h-1.5 bg-blue-100 rounded-full overflow-hidden">
                          <div className="h-full bg-blue-600 transition-all" style={{ width: `${task.progress}%` }} />
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {sortedTasks.filter(t => t.priority === 'high').length > 0 && (
                <div className="bg-white rounded-lg p-3 border">
                  <div className="flex items-center justify-between mb-2">
                    <h2 className="text-sm font-semibold flex items-center gap-1.5">
                      <AlertCircle className="w-4 h-4 text-orange-600" />ë§ˆê° ì„ë°•
                    </h2>
                    <span className="text-xs text-gray-500">
                      {sortedTasks.filter(t => t.priority === 'high').length}ê°œ
                    </span>
                  </div>
                  <div className="space-y-2">
                    {sortedTasks.filter(t => t.priority === 'high').slice(0, 3).map(task => (
                      <div key={task.id} className="p-2.5 bg-orange-50 rounded-lg border border-orange-100 active:bg-orange-100 cursor-pointer" onClick={() => openTaskDetail(task)}>
                        <div className="flex justify-between items-center">
                          <div className="flex-1">
                            <h3 className="font-medium text-sm leading-tight mb-0.5">{task.title}</h3>
                            <p className="text-[11px] text-gray-600">{new Date(task.deadline).toLocaleDateString('ko-KR')}</p>
                          </div>
                          <div className="text-right ml-3 flex-shrink-0">
                            <span className="text-base font-bold text-orange-600 block leading-tight">{getDaysLeft(task.deadline)}</span>
                            <p className="text-[10px] text-gray-500">{task.progress}%</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {tasks.length === 0 && (
                <div className="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-6 text-center border border-blue-200">
                  <div className="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-3">
                    <Target className="w-8 h-8 text-white" />
                  </div>
                  <h3 className="text-base font-semibold text-gray-900 mb-1">ì²« ê³¼ì œë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”</h3>
                  <p className="text-xs text-gray-600 mb-4">AIê°€ ìë™ìœ¼ë¡œ ì¼ì¼ ê³„íšì„ ë§Œë“¤ì–´ë“œë¦½ë‹ˆë‹¤</p>
                  <button 
                    onClick={() => setShowAddModal(true)}
                    className="bg-blue-600 text-white px-6 py-2.5 rounded-lg text-sm font-medium active:scale-95 transition-transform"
                  >
                    ê³¼ì œ ì¶”ê°€í•˜ê¸°
                  </button>
                </div>
              )}
            </div>
          )}

          {currentView === 'today' && (
            <div className="space-y-4">
              <div className="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-5 text-white shadow-lg">
                <h2 className="text-xl font-bold mb-1">ì˜¤ëŠ˜ì˜ ëª©í‘œ</h2>
                <p className="text-blue-100 text-sm">{new Date().toLocaleDateString('ko-KR', { month: 'long', day: 'numeric', weekday: 'long' })}</p>
              </div>
              {todayTasks.length === 0 ? (
                <div className="bg-white rounded-xl p-8 border text-center">
                  <Check className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                  <p className="text-gray-500 text-sm">ì˜¤ëŠ˜ ì˜ˆì •ëœ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤</p>
                </div>
              ) : (
                todayTasks.map(task => (
                  <div key={task.id} className="bg-white rounded-xl p-4 border shadow-sm">
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <h3 className="text-base font-semibold mb-1">{task.title}</h3>
                        <span className={`text-xs px-2 py-0.5 rounded-full ${getPriorityColor(task.priority)}`}>
                          {getDaysLeft(task.deadline)}
                        </span>
                      </div>
                      <button 
                        onClick={() => toggleDailyPlan(task.id, task.dayIndex)}
                        className={`w-8 h-8 rounded-lg border-2 flex items-center justify-center flex-shrink-0 ml-2 active:scale-95 transition-transform ${
                          task.completedDays.includes(task.dayIndex) ? 'bg-green-600 border-green-600' : 'border-gray-300'
                        }`}
                      >
                        {task.completedDays.includes(task.dayIndex) && <Check className="w-5 h-5 text-white" />}
                      </button>
                    </div>
                    <h4 className="font-medium text-sm mb-2">{task.todayPlan.title}</h4>
                    <div className="flex items-center gap-2 text-xs text-gray-600 mb-3">
                      <Clock className="w-3 h-3" />{task.todayPlan.duration} â€¢ {task.todayPlan.focus}
                    </div>
                    <div className="space-y-2">
                      {task.todayPlan.tasks.map((t, idx) => (
                        <div key={idx} className="flex items-center gap-2 text-sm p-2 bg-gray-50 rounded">
                          <div className="w-1.5 h-1.5 rounded-full bg-blue-600 flex-shrink-0" />
                          <span className="flex-1">{t}</span>
                        </div>
                      ))}
                    </div>
                  </div>
                ))
              )}
            </div>
          )}

          {currentView === 'tasks' && (
            <div className="space-y-3">
              {sortedTasks.length === 0 ? (
                <div className="bg-white rounded-xl p-8 border text-center">
                  <List className="w-12 h-12 text-gray-300 mx-auto mb-3" />
                  <p className="text-gray-500 text-sm mb-3">ë“±ë¡ëœ ê³¼ì œê°€ ì—†ìŠµë‹ˆë‹¤</p>
                  <button onClick={() => setShowAddModal(true)} className="text-blue-600 text-sm font-medium">
                    ì²« ê³¼ì œ ì¶”ê°€í•˜ê¸° â†’
                  </button>
                </div>
              ) : (
                sortedTasks.map(task => (
                  <div 
                    key={task.id} 
                    onClick={() => openTaskDetail(task)}
                    className="bg-white rounded-xl p-4 border shadow-sm active:scale-98 transition-transform cursor-pointer"
                  >
                    <div className="flex justify-between items-start mb-3">
                      <div className="flex-1">
                        <h3 className="font-semibold text-sm mb-1">{task.title}</h3>
                        {task.description && <p className="text-xs text-gray-600 line-clamp-2">{task.description}</p>}
                      </div>
                      <button 
                        onClick={(e) => { e.stopPropagation(); deleteTask(task.id); }} 
                        className="text-gray-400 active:text-red-500 ml-2 p-1"
                      >
                        <Trash2 className="w-4 h-4" />
                      </button>
                    </div>
                    <div className="flex gap-2 mb-3 text-xs flex-wrap">
                      <span className={`px-2 py-1 rounded-full border font-medium ${getPriorityColor(task.priority)}`}>
                        {task.priority === 'high' ? 'ê¸´ê¸‰' : task.priority === 'medium' ? 'ë³´í†µ' : 'ì—¬ìœ '}
                      </span>
                      <span className="text-gray-600 flex items-center gap-1 px-2 py-1">
                        <Clock className="w-3 h-3" />{getDaysLeft(task.deadline)}
                      </span>
                    </div>
                    <div>
                      <div className="flex justify-between text-xs text-gray-600 mb-1">
                        <span>ì§„í–‰ë¥ </span><span>{task.progress}%</span>
                      </div>
                      <div className="h-2 bg-gray-200 rounded-full overflow-hidden">
                        <div className="h-full bg-gradient-to-r from-blue-600 to-blue-500 transition-all" style={{ width: `${task.progress}%` }} />
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
          )}

          {currentView === 'calendar' && (
            <div className="bg-white rounded-xl p-4 border shadow-sm">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-base font-semibold">{currentDate.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long' })}</h2>
                <div className="flex gap-2">
                  <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1))}
                    className="p-2 hover:bg-gray-100 rounded-lg active:scale-95 transition-transform">
                    <ChevronLeft className="w-4 h-4" />
                  </button>
                  <button onClick={() => setCurrentDate(new Date())} 
                    className="px-3 py-1 text-xs bg-gray-100 rounded-lg active:scale-95 transition-transform">
                    ì˜¤ëŠ˜
                  </button>
                  <button onClick={() => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1))}
                    className="p-2 hover:bg-gray-100 rounded-lg active:scale-95 transition-transform">
                    <ChevronRight className="w-4 h-4" />
                  </button>
                </div>
              </div>

              <div className="grid grid-cols-7 gap-1 mb-2">
                {['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '].map(day => (
                  <div key={day} className="text-center text-xs font-medium text-gray-600 py-2">{day}</div>
                ))}
              </div>

              <div className="grid grid-cols-7 gap-1">
                {calendarDays.map((day, idx) => (
                  <div key={idx} className={`min-h-16 p-1 rounded-lg border text-center ${
                    day.isToday ? 'bg-blue-50 border-blue-300' : day.isCurrentMonth ? 'bg-white border-gray-200' : 'bg-gray-50 border-gray-100'
                  }`}>
                    <div className={`text-xs font-medium mb-1 ${day.isToday ? 'text-blue-600' : day.isCurrentMonth ? 'text-gray-900' : 'text-gray-400'}`}>
                      {day.day}
                    </div>
                    {day.tasks.length > 0 && (
                      <div className="space-y-0.5">
                        {day.tasks.slice(0, 1).map(task => (
                          <div key={task.id} className={`text-[10px] px-1 py-0.5 rounded truncate ${
                            task.priority === 'high' ? 'bg-orange-100 text-orange-700' :
                            task.priority === 'medium' ? 'bg-blue-100 text-blue-700' : 'bg-gray-100 text-gray-700'
                          }`}>{task.title}</div>
                        ))}
                        {day.tasks.length > 1 && (
                          <div className="text-[10px] text-gray-500">+{day.tasks.length - 1}</div>
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            </div>
          )}
        </main>

        <nav className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-40 max-w-md mx-auto">
          <div className="grid grid-cols-4">
            {[
              { id: 'dashboard', label: 'í™ˆ', icon: Home },
              { id: 'today', label: 'ì˜¤ëŠ˜', icon: Check },
              { id: 'tasks', label: 'ê³¼ì œ', icon: List },
              { id: 'calendar', label: 'ìº˜ë¦°ë”', icon: Calendar }
            ].map(tab => (
              <button
                key={tab.id}
                onClick={() => setCurrentView(tab.id)}
                className={`flex flex-col items-center py-3 transition-colors ${
                  currentView === tab.id ? 'text-blue-600' : 'text-gray-400'
                }`}
              >
                <tab.icon className="w-5 h-5 mb-1" />
                <span className="text-xs font-medium">{tab.label}</span>
              </button>
            ))}
          </div>
        </nav>

        {showAddModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 animate-in fade-in">
            <div className="bg-white rounded-t-2xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom">
              <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                <h2 className="text-lg font-semibold">ìƒˆ ê³¼ì œ ì¶”ê°€</h2>
                <button onClick={() => {
                  setShowAddModal(false);
                  setNewTask({ title: '', description: '', deadline: '' });
                }} className="p-2 hover:bg-gray-100 rounded-lg">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <div className="p-4 space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">ê³¼ì œëª… *</label>
                  <input
                    type="text"
                    value={newTask.title}
                    onChange={(e) => setNewTask(prev => ({ ...prev, title: e.target.value }))}
                    placeholder="ì˜ˆ: ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ë³´ê³ ì„œ"
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg text-base"
                    disabled={isGenerating}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">ê³¼ì œ ì„¤ëª…</label>
                  <textarea
                    value={newTask.description}
                    onChange={(e) => setNewTask(prev => ({ ...prev, description: e.target.value }))}
                    placeholder="ê³¼ì œ ë‚´ìš© (ì„ íƒ)"
                    rows={3}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg resize-none text-base"
                    disabled={isGenerating}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">ë§ˆê°ì¼ *</label>
                  <input
                    type="date"
                    value={newTask.deadline}
                    onChange={(e) => setNewTask(prev => ({ ...prev, deadline: e.target.value }))}
                    min={new Date().toISOString().split('T')[0]}
                    className="w-full px-4 py-3 border border-gray-300 rounded-lg text-base"
                    disabled={isGenerating}
                  />
                </div>

                {isGenerating && (
                  <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex items-center gap-3 mb-2">
                      <div className="w-5 h-5 border-2 border-blue-600 border-t-transparent rounded-full animate-spin" />
                      <span className="text-sm font-medium text-blue-700">AIê°€ ì¼ì¼ ê³„íš ìƒì„± ì¤‘...</span>
                    </div>
                    <p className="text-xs text-blue-600 ml-8">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”</p>
                  </div>
                )}

                <div className="flex gap-3 pt-2 pb-4">
                  <button
                    onClick={() => {
                      setShowAddModal(false);
                      setNewTask({ title: '', description: '', deadline: '' });
                    }}
                    disabled={isGenerating}
                    className="flex-1 px-4 py-3 border border-gray-300 text-gray-700 rounded-lg font-medium disabled:opacity-50"
                  >
                    ì·¨ì†Œ
                  </button>
                  <button
                    onClick={handleAddTask}
                    disabled={isGenerating || !newTask.title.trim() || !newTask.deadline}
                    className="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-medium disabled:opacity-50"
                  >
                    {isGenerating ? 'ìƒì„± ì¤‘...' : 'ì¶”ê°€í•˜ê¸°'}
                  </button>
                </div>
              </div>
            </div>
          </div>
        )}

        {showTaskDetail && selectedTask && (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-end justify-center z-50 animate-in fade-in">
            <div className="bg-white rounded-t-2xl w-full max-w-md max-h-[90vh] overflow-y-auto animate-in slide-in-from-bottom">
              <div className="sticky top-0 bg-white border-b px-4 py-3 flex justify-between items-center">
                <h2 className="text-lg font-semibold">ê³¼ì œ ìƒì„¸</h2>
                <button onClick={() => setShowTaskDetail(false)} className="p-2 hover:bg-gray-100 rounded-lg">
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="p-4 space-y-6">
                <div>
                  <h3 className="font-semibold text-lg mb-2">{selectedTask.title}</h3>
                  {selectedTask.description && <p className="text-sm text-gray-600 mb-3">{selectedTask.description}</p>}
                  <div className="flex items-center gap-2 text-sm text-gray-600">
                    <Clock className="w-4 h-4" />
                    <span>ì˜ˆìƒ {selectedTask.plan?.estimatedHours || 4}ì‹œê°„</span>
                  </div>
                </div>

                {selectedTask.plan?.dailyPlans && (
                  <div>
                    <h4 className="font-medium text-base mb-3">ğŸ“… ì¼ì¼ ê³„íš</h4>
                    <div className="space-y-3">
                      {selectedTask.plan.dailyPlans.map((day, idx) => (
                        <div key={idx} className={`p-3 rounded-lg border ${
                          selectedTask.completedDays.includes(idx) ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'
                        }`}>
                          <div className="flex gap-3">
                            <button 
                              onClick={() => toggleDailyPlan(selectedTask.id, idx)}
                              className={`w-6 h-6 rounded border-2 flex items-center justify-center flex-shrink-0 mt-0.5 ${
                                selectedTask.completedDays.includes(idx) ? 'bg-green-600 border-green-600' : 'border-gray-300'
                              }`}
                            >
                              {selectedTask.completedDays.includes(idx) && <Check className="w-4 h-4 text-white" />}
                            </button>
                            <div className="flex-1">
                              <div className="flex justify-between mb-1">
                                <span className={`text-sm font-medium ${
                                  selectedTask.completedDays.includes(idx) ? 'line-through text-gray-500' : ''
                                }`}>
                                  Day {day.day}: {day.title}
                                </span>
                                <span className="text-xs text-gray-500">{day.duration}</span>
                              </div>
                              <p className="text-xs text-gray-600 mb-2">{day.focus}</p>
                              <div className="space-y-1">
                                {day.tasks.map((t, i) => (
                                  <div key={i} className="flex items-start gap-2 text-xs text-gray-600">
                                    <div className="w-1 h-1 rounded-full bg-gray-400 mt-1.5 flex-shrink-0" />
                                    <span>{t}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                <div>
                  <h4 className="font-medium text-base mb-3">ğŸ¯ ë‹¨ê³„ë³„ ê°€ì´ë“œ</h4>
                  <div className="space-y-3">
                    {selectedTask.plan?.steps.map((step, idx) => (
                      <div key={idx} className={`p-3 rounded-lg border ${
                        selectedTask.completedSteps.includes(idx) ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200'
                      }`}>
                        <div className="flex gap-3">
                          <button 
                            onClick={() => toggleStep(selectedTask.id, idx)}
                            className={`w-6 h-6 rounded border-2 flex items-center justify-center flex-shrink-0 mt-0.5 ${
                              selectedTask.completedSteps.includes(idx) ? 'bg-blue-600 border-blue-600' : 'border-gray-300'
                            }`}
                          >
                            {selectedTask.completedSteps.includes(idx) && <Check className="w-4 h-4 text-white" />}
                          </button>
                          <div className="flex-1">
                            <div className="flex justify-between mb-1">
                              <span className={`text-sm font-medium ${
                                selectedTask.completedSteps.includes(idx) ? 'line-through text-gray-500' : ''
                              }`}>
                                {step.title}
                              </span>
                              <span className="text-xs text-gray-500">{step.duration}</span>
                            </div>
                            <p className="text-xs text-gray-600">{step.description}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="pb-4">
                  <h4 className="font-medium text-base mb-3 flex items-center gap-2">
                    <AlertCircle className="w-4 h-4 text-orange-500" />ì œì¶œ ì „ ì²´í¬ë¦¬ìŠ¤íŠ¸
                  </h4>
                  <div className="space-y-2">
                    {selectedTask.plan?.checklist.map((item, idx) => (
                      <div key={idx} className="flex items-start gap-2 text-sm text-gray-700">
                        <div className="w-1.5 h-1.5 rounded-full bg-orange-500 mt-1.5 flex-shrink-0" />
                        <span>{item}</span>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default TaskDeadlineManager;
